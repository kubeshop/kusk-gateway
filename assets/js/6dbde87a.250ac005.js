"use strict";(self.webpackChunkkusk_gateway_docs_2=self.webpackChunkkusk_gateway_docs_2||[]).push([[606],{3905:(e,t,a)=>{a.d(t,{Zo:()=>s,kt:()=>d});var n=a(7294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var u=n.createContext({}),p=function(e){var t=n.useContext(u),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},s=function(e){var t=p(e.components);return n.createElement(u.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,o=e.originalType,u=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),h=p(a),d=i,m=h["".concat(u,".").concat(d)]||h[d]||c[d]||o;return a?n.createElement(m,r(r({ref:t},s),{},{components:a})):n.createElement(m,r({ref:t},s))}));function d(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=a.length,r=new Array(o);r[0]=h;var l={};for(var u in t)hasOwnProperty.call(t,u)&&(l[u]=t[u]);l.originalType=e,l.mdxType="string"==typeof e?e:i,r[1]=l;for(var p=2;p<o;p++)r[p]=a[p];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"},857:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>u,contentTitle:()=>r,default:()=>c,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var n=a(7462),i=(a(7294),a(3905));const o={},r="OAuth2",l={unversionedId:"guides/oauth2",id:"guides/oauth2",title:"OAuth2",description:"The OAuth2 feature is currently under active development.",source:"@site/docs/guides/oauth2.md",sourceDirName:"guides",slug:"/guides/oauth2",permalink:"/guides/oauth2",draft:!1,editUrl:"https://github.com/kubeshop/kusk-gateway/docs/guides/oauth2.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Authentication",permalink:"/guides/basic-auth"},next:{title:"Using Cert Manager with Kusk Gateway",permalink:"/guides/cert-manager"}},u={},p=[{value:"Upstream Issues",id:"upstream-issues",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Examples",id:"examples",level:2},{value:"Example - Auth0",id:"example---auth0",level:3},{value:"Setup Guide",id:"setup-guide",level:4},{value:"Configuration",id:"configuration-1",level:4},{value:"API Object",id:"api-object",level:4},{value:"Apply API Object",id:"apply-api-object",level:4},{value:"Envoy Fleet",id:"envoy-fleet",level:3},{value:"Complete End-2-End Run",id:"complete-end-2-end-run",level:3},{value:"References",id:"references",level:2}],s={toc:p};function c(e){let{components:t,...o}=e;return(0,i.kt)("wrapper",(0,n.Z)({},s,o,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"oauth2"},(0,i.kt)("inlineCode",{parentName:"h1"},"OAuth2")),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"},"The OAuth2 feature is currently under active development.")),(0,i.kt)("p",null,"OAuth2 ensures that your application (upstream) doesn't get requests which are not authenticated and authorized. It effectively helps to protect your API. See the ",(0,i.kt)("a",{parentName:"p",href:"./#references"},(0,i.kt)("inlineCode",{parentName:"a"},"References"))," section for further information."),(0,i.kt)("h2",{id:"upstream-issues"},"Upstream Issues"),(0,i.kt)("p",null,"Certain OAuth2 features are blocked/constrained by upstream issues. Please see:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/envoyproxy/envoy/issues/22678"},"Segmentation Fault after `assert failure: false. Details: attempted to add shared target SdsApi <NAME_OF_SECRET> to initialized init manager Server"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/envoyproxy/go-control-plane/issues/581"},(0,i.kt)("inlineCode",{parentName:"a"},"SecretDiscoveryServiceServer"),": ",(0,i.kt)("inlineCode",{parentName:"a"},"StreamSecrets")," issues"),".")),(0,i.kt)("p",null,"So the implementation is constrained by these issues."),(0,i.kt)("h2",{id:"configuration"},"Configuration"),(0,i.kt)("p",null,"Kusk makes it easy to configure OAuth2, using the ",(0,i.kt)("inlineCode",{parentName:"p"},"auth")," option in the ",(0,i.kt)("inlineCode",{parentName:"p"},"x-kusk")," extension."),(0,i.kt)("p",null,"Be sure to read the ",(0,i.kt)("a",{parentName:"p",href:"#envoy-fleet"},(0,i.kt)("inlineCode",{parentName:"a"},"Envoy Fleet"))," for how to configure Envoy Fleet to get the values for the ",(0,i.kt)("inlineCode",{parentName:"p"},"client_secret")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"hmac_secret"),"."),(0,i.kt)("h2",{id:"examples"},"Examples"),(0,i.kt)("h3",{id:"example---auth0"},"Example - Auth0"),(0,i.kt)("p",null,"Example using ",(0,i.kt)("a",{parentName:"p",href:"https://auth0.com/"},"Auth0"),":"),(0,i.kt)("h4",{id:"setup-guide"},"Setup Guide"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Signup for an account at ",(0,i.kt)("a",{parentName:"li",href:"https://auth0.com/"},"Auth0"),"."),(0,i.kt)("li",{parentName:"ol"},"Follow the steps as outlined in the video below, taking note of:",(0,i.kt)("ol",{parentName:"li"},(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"OAuth Authorization URL"),"."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"OAuth Token URL"),"."),(0,i.kt)("li",{parentName:"ol"},"Entering a comma separated list of ",(0,i.kt)("inlineCode",{parentName:"li"},"Allowed Logout URLs"),", e.g., ",(0,i.kt)("inlineCode",{parentName:"li"},"http://<Envoy_LoadBalancer_IP>/oauth2/signout,https://<Envoy_LoadBalancer_IP>/oauth2/signout"),"."),(0,i.kt)("li",{parentName:"ol"},"Entering a comma separated list of ",(0,i.kt)("inlineCode",{parentName:"li"},"Allowed Callback URLs"),", e.g., ",(0,i.kt)("inlineCode",{parentName:"li"},"http://<Envoy_LoadBalancer_IP>/oauth2/callback,https://<Envoy_LoadBalancer_IP>/oauth2/callback"),"."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"Client ID"),"."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"Client Secret"),".")))),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"0auth-create-regular-web-client-0.gif",src:a(7414).Z,width:"1275",height:"601"})),(0,i.kt)("p",null,"Take note of the credentials as we will need this later on:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "client_id": "go8brZmF6eE6r7TObzpGaD5KFjJkm6Qb",\n  "client_secret": "bkryzZGGA6Ko0VGnUEl_1YeREMHDpjGP8r1BTN1HYlmXpAWaiWNkD4bqIDuAuCKV"\n}\n')),(0,i.kt)("h4",{id:"configuration-1"},"Configuration"),(0,i.kt)("h4",{id:"api-object"},"API Object"),(0,i.kt)("p",null,"You are required to change:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"token_endpoint"),"."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"authorization_endpoint"),"."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"credentials.client_id"),"."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"credentials.client_secret"),"."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"auth_scopes"),": Strictly speaking this is not required but we strongly suggest entering ",(0,i.kt)("inlineCode",{parentName:"li"},"openid")," ",(0,i.kt)("em",{parentName:"li"},"only"),' for now because as we mentioned earlier "OAuth2 feature is currently under active development".')),(0,i.kt)("p",null,"An example ",(0,i.kt)("inlineCode",{parentName:"p"},"API")," specification and associated deployments."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"api.yml"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: gateway.kusk.io/v1alpha1\nkind: API\nmetadata:\n  name: auth-oauth2-oauth0-authorization-code-grant\n  namespace: default\nspec:\n  fleet:\n    name: default\n    namespace: default\n  spec: |\n    openapi: 3.0.0\n    info:\n      title: auth-oauth2-oauth0-authorization-code-grant\n      description: auth-oauth2-oauth0-authorization-code-grant\n      version: \'0.1.0\'\n    schemes:\n    - http\n    - https\n    x-kusk:\n      upstream:\n        service:\n          name: auth-oauth2-oauth0-authorization-code-grant-go-httpbin\n          namespace: default\n          port: 80\n      auth:\n        scheme: oauth2\n        oauth2:\n          token_endpoint: https://kubeshop-kusk-gateway-oauth2.eu.auth0.com/oauth/token\n          authorization_endpoint: https://kubeshop-kusk-gateway-oauth2.eu.auth0.com/authorize\n          credentials:\n            client_id: go8brZmF6eE6r7TObzpGaD5KFjJkm6Qb\n            client_secret: bkryzZGGA6Ko0VGnUEl_1YeREMHDpjGP8r1BTN1HYlmXpAWaiWNkD4bqIDuAuCKV\n          redirect_uri: /oauth2/callback\n          redirect_path_matcher: /oauth2/callback\n          signout_path: /oauth2/signout\n          forward_bearer_token: true\n          auth_scopes:\n            - openid\n    paths:\n      "/":\n        get:\n          description: Returns GET data.\n          operationId: "/get"\n          responses: {}\n      "/uuid":\n        get:\n          description: Returns UUID4.\n          operationId: "/uuid"\n          responses: {}\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: auth-oauth2-oauth0-authorization-code-grant-go-httpbin\n  namespace: default\n  labels:\n    app: auth-oauth2-oauth0-authorization-code-grant-go-httpbin\nspec:\n  selector:\n    matchLabels:\n      app: auth-oauth2-oauth0-authorization-code-grant-go-httpbin\n  replicas: 1\n  template:\n    metadata:\n      labels:\n        app: auth-oauth2-oauth0-authorization-code-grant-go-httpbin\n    spec:\n      containers:\n        - name: auth-oauth2-oauth0-authorization-code-grant-go-httpbin\n          image: docker.io/mccutchen/go-httpbin:v2.4.1\n          ports:\n            - containerPort: 8080\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: auth-oauth2-oauth0-authorization-code-grant-go-httpbin\n  namespace: default\n  labels:\n    app: auth-oauth2-oauth0-authorization-code-grant-go-httpbin\nspec:\n  selector:\n    app: auth-oauth2-oauth0-authorization-code-grant-go-httpbin\n  ports:\n    - name: http\n      protocol: TCP\n      port: 80\n      targetPort: 8080\n')),(0,i.kt)("p",null,"The example above ensures the whole API is protected via OAuth2, and that ",(0,i.kt)("inlineCode",{parentName:"p"},"auth-oauth2-oauth0-authorization-code-grant-go-httpbin")," can be only accessed when authenticated and authorized."),(0,i.kt)("h4",{id:"apply-api-object"},"Apply API Object"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"kubectl apply -f ./api.yml\n")),(0,i.kt)("h3",{id:"envoy-fleet"},"Envoy Fleet"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Note:")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The commands assume you are running Linux."),(0,i.kt)("li",{parentName:"ul"},"The Envoy Fleet is running in the ",(0,i.kt)("inlineCode",{parentName:"li"},"default")," namespace, and the service is named ",(0,i.kt)("inlineCode",{parentName:"li"},"default"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"192.168.49.2")," is the ",(0,i.kt)("inlineCode",{parentName:"li"},"LoadBalancer")," IP assigned to Envoy, ",(0,i.kt)("em",{parentName:"li"},"or")," you are port forwarding the admin port on the Envoy Fleet to ",(0,i.kt)("inlineCode",{parentName:"li"},"19000")," using `",(0,i.kt)("inlineCode",{parentName:"li"},"kubectl port-forward --namespace default service/default 19000:19000"),".")),(0,i.kt)("p",null,"The secrets need to be part of the static Envoy Fleet configuration. The way to inject the ",(0,i.kt)("inlineCode",{parentName:"p"},"client_secret")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"hmac_secret")," is as follows:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Change ",(0,i.kt)("inlineCode",{parentName:"li"},"secrets.token.generic_secret.secret.inline")," to ",(0,i.kt)("inlineCode",{parentName:"li"},'"bkryzZGGA6Ko0VGnUEl_1YeREMHDpjGP8r1BTN1HYlmXpAWaiWNkD4bqIDuAuCKV"')," by using ",(0,i.kt)("inlineCode",{parentName:"li"},"kubectl edit configmap/default"),", i.e., look for this block:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'  secrets:\n  - name: token\n    generic_secret:\n      secret:\n        inline_string: "<stub_token_secret>"\n')),(0,i.kt)("p",null,"And modify ",(0,i.kt)("inlineCode",{parentName:"p"},"inline_string"),"."),(0,i.kt)("ol",{start:2},(0,i.kt)("li",{parentName:"ol"},"Port forward the admin port: ",(0,i.kt)("inlineCode",{parentName:"li"},"kubectl port-forward --namespace default service/default 19000:19000 &")),(0,i.kt)("li",{parentName:"ol"},"Restart Envoy by using ",(0,i.kt)("inlineCode",{parentName:"li"},"curl -X POST 'http: //localhost:19000/quitquitquit'"),"."),(0,i.kt)("li",{parentName:"ol"},"Wait until the changes to be propogated, this could take a while."),(0,i.kt)("li",{parentName:"ol"},"Delete and create the API again using ",(0,i.kt)("inlineCode",{parentName:"li"},"kubectl delete -f ./api.yml && kubectl apply -f ./api.yml")),(0,i.kt)("li",{parentName:"ol"},"Navigate to the protected route(s) in a browser, i.e., ",(0,i.kt)("a",{parentName:"li",href:"http://localhost/uuid"},"http://localhost/uuid")," or ",(0,i.kt)("a",{parentName:"li",href:"https://localhost/uuid"},"https://localhost/uuid"),".")),(0,i.kt)("p",null,"The commands are listed below:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"$ kubectl edit configmap/default\n$ curl -X POST 'http: //localhost:19000/quitquitquit'\nOK\n$ kubectl delete -f ./api.yml && kubectl apply -f ./api.yml\n$ # Open http://localhost/uuid or https://localhost/uuid in a browser.\n")),(0,i.kt)("h3",{id:"complete-end-2-end-run"},"Complete End-2-End Run"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"access-auth-route-terminal-0",src:a(5756).Z,width:"1275",height:"601"})),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"access-auth-route-browser-0",src:a(6868).Z,width:"1275",height:"601"})),(0,i.kt)("h2",{id:"references"},"References"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/OAuth"},"OAuth"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://developer.okta.com/blog/2017/06/21/what-the-heck-is-oauth"},"What the Heck is OAuth?"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://www.ory.sh/hydra/"},"Open Source OAuth 2.0 and OpenID Connect Server - gethydra.sh"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/oauth2_filter"},(0,i.kt)("inlineCode",{parentName:"a"},"OAuth2 \u2014 envoy@latest"))," or ",(0,i.kt)("a",{parentName:"li",href:"https://www.envoyproxy.io/docs/envoy/v1.23.0/configuration/http/http_filters/oauth2_filter"},(0,i.kt)("inlineCode",{parentName:"a"},"OAuth2 \u2014 envoy@v1.23.0")),".")))}c.isMDXComponent=!0},7414:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/0auth-create-regular-web-client-0-ff82ce4da7f39a5065fc2138e7f79e9e.gif"},6868:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/access-auth-route-browser-0-e981e969951f83c917e4a66e3df041f2.gif"},5756:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/access-auth-route-terminal-0-48aec27eaa4a88753a4941849dd44284.gif"}}]);